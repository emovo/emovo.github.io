<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <title>Profile</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="328858787046-95fsdbnk5kil4druiacprsubihssktju.apps.googleusercontent.com">
    <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <style>
    body,h1,h2,h3,h4,h5,h6 {font-family: "Raleway", Arial, Helvetica, sans-serif}
    .myLink {display: none}
    </style>
  </head>
  <body class="w3-light-grey">
    <!-- Navigation Bar -->
    <div id="gsignin2" class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
    <div class="mainDiv" style="text-align: center; display: block; margin: 0 auto;">
      <div id="userContent" class="w3-row-padding w3-padding-64 w3-container">
        <div class="w3-content">
          <div class="w3-twothird">
            <h1 id="username"></h1>
            <p id="joinDate"></p>
            <img id="pic" src="#">
            <p id="yourSearches" class="w3-text-grey"></p>
            <p id="placeRecs" class="w3-text-grey"></p>
            <p id="commentHistory" class="w3-text-grey"></p>
          </div>
        </div>
      </div>
      <p></p>
      <div id="signout" class="btn white darken-4 col s10 m4">
           <button class="w3-button w3-dark-grey" onclick="signOut();">
               <div class="left">
                   <img width="20px" alt="Google &quot;G&quot; Logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Google_%22G%22_Logo.svg/512px-Google_%22G%22_Logo.svg.png"/>
                   Sign out
               </div>
           </button>
      </div>
    </div>
    <script>
      var config = {
          apiKey: "AIzaSyAeVY1LvG9hNSBYb9_raGpYYDiHIvG3cY8",
          authDomain: "emovousers.firebaseapp.com",
          databaseURL: "https://emovousers.firebaseio.com/",
          storageBucket: "emovousers.appspot.com"
        }
      firebase.initializeApp(config);
      var isIn=isLoggedIn();
      console.log(isIn)
      var account={};
      if(isIn==false){
        document.getElementById('gsignin2').style.display = "block";
        document.getElementById("userContent").style.display = "none";
        document.getElementById("signout").style.display = "none";
      }
      function onSignIn() {
        // Useful data for your client-side scripts:
        const googleUser = gapi.auth2.getAuthInstance().currentUser.get();
        const profile = googleUser.getBasicProfile();
        //var profile = googleUser.getBasicProfile();
        console.log("ID: " + profile.getId()); // Don't send this directly to your server!
        console.log('Full Name: ' + profile.getName());
        console.log('Given Name: ' + profile.getGivenName());
        console.log('Family Name: ' + profile.getFamilyName());
        console.log("Image URL: " + profile.getImageUrl());
        console.log("Email: " + profile.getEmail());
        // The ID token you need to pass to your backend:
        document.getElementById('gsignin2').style.display = "none";
        document.getElementById("userContent").style.display = "block";
        document.getElementById("signout").style.display = "block";
        var id_token = googleUser.getAuthResponse().id_token;
        console.log("ID Token: " + id_token);
        document.getElementById("username").innerHTML="Hi "+profile.getGivenName()+"!";
        document.getElementById("pic").src=profile.getImageUrl();
        //firebase retrieval here
        /*
        document.getElementById("joinDate").innerHTML
        <p id="yourSearches" class="w3-text-grey"></p>
        <p id="placeRecs" class="w3-text-grey"></p>
        <p id="commentHistory" class="w3-text-grey"></p>
        var currentdate = new Date();
        var datetime = "Last Sync: " + currentdate.getDate() + "/"
                        + (currentdate.getMonth()+1)  + "/"
                        + currentdate.getFullYear() + " @ "
                        + currentdate.getHours() + ":"
                        + currentdate.getMinutes() + ":"
                        + currentdate.getSeconds();
        */
        var currUser = {};
        currUser["id"] = profile.getId();
        currUser["name"] = profile.getGivenName(); //first name only
        currUser["picture"] = profile.getImageUrl();
        sessionStorage.setItem('currUser',JSON.stringify(currUser));
        var sRef = firebase.database().ref().child("users")
        sRef.on("value", function(snapshot, prevChildKey) {
          var snapshotData = snapshot.val();
          console.log(snapshotData)
          if(snapshotData==null){ //database doesnt exist
            var sRef2 = firebase.database().ref()
            sRef2.child("users").set({})
            firebase.database().ref().child("users").child(currUser["id"]).set({
              "id":currUser["id"],
              "name":currUser["name"],
              "picture":currUser["picture"],
              "joinDate":currUser["joinDate"],
              "comments":[]
            })
          }
          else{
            var sRef2 = firebase.database().ref().child("users").child(currUser["id"])//check if user in database
            sRef2.on("value", function(snapshot2, prevChildKey) {
              var snapshotData2 = snapshot2.val();
              if(snapshotData2==null){ //user not there
                var sRef3 = firebase.database().ref()
                var date = new Date();
                var day = date.getDate();
                var month = date.toLocaleString('default', { month: 'long'});
                var year = date.getFullYear();
                var stDate = month+" "+day+", "+year
                currUser["joinDate"] = stDate;
                console.log(month);
                sRef3.child("users").set({
                  "id":currUser["id"],
                  "name":currUser["name"],
                  "picture":currUser["picture"],
                  "joinDate":currUser["joinDate"],
                  "comments":[]
                })
              }else{
                console.log(snapshotData2)
              }
            })
          }
        })
      }
      function isLoggedIn()
      {
        if(sessionStorage.getItem('currUser') == null){
          return false;
        } else {
          return true;
        }
      }
      function signOut() {
        sessionStorage.clear();
        document.getElementById('gsignin2').style.display = "block";
        document.getElementById("userContent").style.display = "none";
        document.getElementById("signout").style.display = "none";
        location.href="https://www.google.com/accounts/Logout?continue=https://appengine.google.com/_ah/logout?continue=https://emovo.github.io/"
      }
    </script>
  </body>
</html>
